PROMPT: 

Code sample to notify the frontend in real-time when a product’s quantity goes below a threshold, using Server-Sent Events (SSE).

RESPONSE:

Absolutely! Here’s a **complete example** showing how to notify the frontend in real-time when a product’s quantity falls below a threshold using **Server-Sent Events (SSE)**. This example includes both backend and frontend code.

---

## 1️⃣ Backend (Node.js + Express + SSE)

```ts
import express from "express";

const app = express();
const PORT = 3000;

// Keep track of connected clients
const clients: express.Response[] = [];

// SSE endpoint
app.get("/events", (req, res) => {
  res.setHeader("Content-Type", "text/event-stream");
  res.setHeader("Cache-Control", "no-cache");
  res.setHeader("Connection", "keep-alive");

  res.flushHeaders(); // flush headers for SSE

  // Add this client to the list
  clients.push(res);

  console.log("Client connected, total:", clients.length);

  // Remove client on disconnect
  req.on("close", () => {
    const index = clients.indexOf(res);
    if (index !== -1) clients.splice(index, 1);
    console.log("Client disconnected, total:", clients.length);
  });
});

// Function to send SSE to all connected clients
function sendSSE(data: any) {
  const message = `data: ${JSON.stringify(data)}\n\n`;
  clients.forEach((client) => client.write(message));
}

// Function to check product quantity and notify if low
function checkQuantity(productId: string, quantity: number, threshold = 5) {
  if (quantity < threshold) {
    sendSSE({ productId, quantity, message: "Quantity is low!" });
  }
}

// Example: simulate product quantity changes every 5 seconds
setInterval(() => {
  const productId = "product-123";
  const quantity = Math.floor(Math.random() * 10); // random quantity 0-9
  console.log(`Product ${productId} quantity: ${quantity}`);
  checkQuantity(productId, quantity);
}, 5000);

app.listen(PORT, () => {
  console.log(`SSE server running at http://localhost:${PORT}/events`);
});
```

---

## 2️⃣ Frontend (Vanilla JS)

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SSE Example</title>
</head>
<body>
  <h1>Product Quantity Alerts</h1>
  <ul id="alerts"></ul>

  <script>
    const alertsList = document.getElementById("alerts");

    // Connect to SSE endpoint
    const eventSource = new EventSource("http://localhost:3000/events");

    // Handle incoming messages
    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data);
      console.log("Low stock alert:", data);

      const li = document.createElement("li");
      li.textContent = `Product ${data.productId} quantity is ${data.quantity}: ${data.message}`;
      alertsList.appendChild(li);
    };

    eventSource.onerror = (err) => {
      console.error("SSE error:", err);
    };
  </script>
</body>
</html>
```

---

### ✅ How it works

1. The frontend connects to `/events` via **EventSource**.
2. Backend stores all connected clients.
3. Whenever a product’s quantity drops below a threshold, the backend sends an SSE message to all clients.
4. Frontend receives the message in real-time and updates the UI.

---

### Optional improvements

* Track **specific products per client** so each client only receives relevant updates.
* Integrate with your **database or SQSConsumer** to notify when real product data changes instead of random simulation.
* Use **TTL or cleanup** for large numbers of clients if needed.

---

If you want, I can also show a **version where SSE is integrated with your existing SQSConsumer**, so the frontend automatically receives alerts whenever `productCount` is updated. This is more realistic for production.

Do you want me to do that?
